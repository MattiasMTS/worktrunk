#!/usr/bin/env python3
"""Build script for documentation site demo GIFs.

Records demos used on the main doc site:
- wt-core: Full workflow (list, switch, config, create, list --full, remove)
- wt-merge: Full merge workflow with LLM commit generation
- wt-select: Interactive worktree selector with preview panels
"""

import os
import shutil
import sys
from pathlib import Path

# Add docs/demos/ to path for shared library
SCRIPT_DIR = Path(__file__).parent
DEMOS_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(DEMOS_DIR))

from shared import (
    DemoEnv, git, prepare_demo_repo,
    check_dependencies, setup_demo_output, record_all_themes,
    SIZE_DOCS,
)

REPO_ROOT = DEMOS_DIR.parent.parent
OUT_DIR = SCRIPT_DIR / "out"
TAPES_DIR = DEMOS_DIR / "tapes"

# All tapes to record: (tape_file, output_base_name, setup_func, vhs_binary)
# Tapes are in ../tapes/ (shared with twitter build)
DEMOS = [
    ("wt-core.tape", "wt-core", "core", "vhs"),
    ("wt-merge.tape", "wt-merge", "merge", "vhs"),
    ("wt-select.tape", "wt-select", "select", "vhs-keystrokes"),
]

# Custom VHS binary with keystroke overlay (for wt-select)
VHS_KEYSTROKES = os.environ.get(
    "VHS_KEYSTROKES",
    str(DEMOS_DIR / "vhs-keystrokes" / "vhs-keystrokes")
)


def prepare_core(env: DemoEnv):
    """Set up repo for wt-core demo with hooks, mocks, and billing branch."""
    hooks_config = '''[post-start]
deps = "npm install"
build = "npm run build"
dev = "npm run dev"
db = "docker compose up -d postgres"

[pre-remove]
cleanup = "flyctl scale count 0"
'''
    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)

    # Mock CLIs for hooks
    bin_dir = env.home / "bin"

    npm_mock = bin_dir / "npm"
    npm_mock.write_text("""#!/bin/bash
if [[ "$1" == "install" ]]; then
    echo "added 847 packages in 3.2s"
elif [[ "$1" == "run" && "$2" == "build" ]]; then
    echo "vite v5.4.2 building for production..."
    echo "✓ 142 modules transformed"
    echo "dist/index.js  45.2 kB │ gzip: 14.8 kB"
elif [[ "$1" == "run" && "$2" == "dev" ]]; then
    echo ""
    echo "  VITE v5.4.2  ready in 342 ms"
    echo ""
    echo "  ➜  Local:   http://localhost:3000/"
fi
""")
    npm_mock.chmod(0o755)

    docker_mock = bin_dir / "docker"
    docker_mock.write_text("""#!/bin/bash
if [[ "$1" == "compose" && "$2" == "up" ]]; then
    echo "[+] Running 1/1"
    echo " ✔ Container postgres  Started"
fi
""")
    docker_mock.chmod(0o755)

    flyctl_mock = bin_dir / "flyctl"
    flyctl_mock.write_text("""#!/bin/bash
if [[ "$1" == "scale" && "$2" == "count" && "$3" == "0" ]]; then
    echo "Scaling app to 0 machines"
fi
""")
    flyctl_mock.chmod(0o755)

    # User config with approved commands
    config_dir = env.home / ".config" / "worktrunk"
    project_id = str(env.bare_remote).removesuffix(".git")
    (config_dir / "config.toml").write_text(f'''[projects."{project_id}"]
approved-commands = ["npm install", "npm run build", "npm run dev", "docker compose up -d postgres", "flyctl scale count 0"]
''')

    # Add billing branch (at same commit as main = merged)
    branch = "billing"
    path = env.work_base / f"acme.{branch}"
    git(["-C", str(env.repo), "worktree", "add", "-q", "-b", branch, str(path), "main"])
    git(["-C", str(path), "push", "-u", "origin", branch, "-q"])


def prepare_merge(env: DemoEnv):
    """Set up repo for wt-merge demo with LLM mock."""
    prepare_demo_repo(env, REPO_ROOT)

    # User config with llm commit generation
    config_dir = env.home / ".config" / "worktrunk"
    project_id = str(env.bare_remote).removesuffix(".git")
    (config_dir / "config.toml").write_text(f'''[commit-generation]
command = "llm"
args = ["-m", "claude-haiku-4.5"]

[projects."{project_id}"]
approved-commands = ["cargo nextest run"]
''')

    # Add uncommitted changes to hooks branch for commit demo
    hooks_path = env.work_base / "acme.hooks"
    if hooks_path.exists():
        new_file = hooks_path / "src" / "validation.rs"
        new_file.write_text('''//! Input validation utilities.

/// Validates that a number is positive.
pub fn is_positive(n: i32) -> bool {
    n > 0
}

/// Validates that a string is not empty.
pub fn is_non_empty(s: &str) -> bool {
    !s.trim().is_empty()
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_is_positive() {
        assert!(is_positive(1));
        assert!(!is_positive(0));
        assert!(!is_positive(-1));
    }
}
''')
        git(["-C", str(hooks_path), "add", "src/validation.rs"])

    # Mock llm CLI
    bin_dir = env.home / "bin"
    bin_dir.mkdir(exist_ok=True)
    llm_mock = bin_dir / "llm"
    llm_mock.write_text("""#!/bin/bash
sleep 0.5
echo "feat(validation): add input validation utilities"
echo ""
echo "Add validation module with is_positive and is_non_empty helpers"
echo "for validating user input. Includes comprehensive test coverage."
""")
    llm_mock.chmod(0o755)


def prepare_select(env: DemoEnv):
    """Set up repo for wt-select demo (standard setup)."""
    prepare_demo_repo(env, REPO_ROOT)


SETUP_FUNCS = {
    "core": prepare_core,
    "merge": prepare_merge,
    "select": prepare_select,
}


def main():
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--only", help="Only record specific demo (e.g., wt-select)")
    args = parser.parse_args()

    check_dependencies(["wt", "vhs", "starship"])
    setup_demo_output(OUT_DIR)

    # Filter demos if --only specified
    demos_to_record = DEMOS
    if args.only:
        demos_to_record = [(t, n, s, v) for t, n, s, v in DEMOS if n == args.only]
        if not demos_to_record:
            print(f"Unknown demo: {args.only}")
            print(f"Available: {', '.join(n for _, n, _, _ in DEMOS)}")
            return

    # Check vhs-keystrokes availability for wt-select
    vhs_keystrokes_available = Path(VHS_KEYSTROKES).exists()
    if not vhs_keystrokes_available:
        print(f"Note: vhs-keystrokes not found at {VHS_KEYSTROKES}")
        print("wt-select demo will be skipped. See docs/demos/vhs-keystrokes/README.md")

    # Record each demo
    for tape_file, output_name, setup_key, vhs_type in demos_to_record:
        tape_path = TAPES_DIR / tape_file
        if not tape_path.exists():
            print(f"Skipping {output_name}: {tape_file} not found")
            continue

        # Check if this demo needs vhs-keystrokes
        if vhs_type == "vhs-keystrokes" and not vhs_keystrokes_available:
            print(f"Skipping {output_name}: requires vhs-keystrokes")
            continue

        vhs_binary = VHS_KEYSTROKES if vhs_type == "vhs-keystrokes" else "vhs"

        output_gifs = {
            "light": OUT_DIR / f"{output_name}.gif",
            "dark": OUT_DIR / f"{output_name}-dark.gif",
        }
        print(f"\n{'='*60}")
        print(f"Recording {output_name}...")
        print(f"{'='*60}")

        # Create fresh environment for each demo
        env = DemoEnv(name=output_name, out_dir=OUT_DIR, repo_name="acme")
        SETUP_FUNCS[setup_key](env)

        print(f"Demo repo: {env.repo}")
        record_all_themes(env, tape_path, output_gifs, REPO_ROOT, vhs_binary=vhs_binary, size=SIZE_DOCS)


if __name__ == "__main__":
    main()
